name: Build Executables

on:
  release:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: yt-segment-gui-linux
            asset_name: yt-segment-gui-linux
          - os: windows-latest
            artifact_name: yt-segment-gui.exe
            asset_name: yt-segment-gui-windows.exe
          - os: macos-12
            artifact_name: yt-segment-gui
            asset_name: yt-segment-gui-macos

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pyinstaller

    - name: Install FFmpeg (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update && sudo apt-get install -y ffmpeg
        cp $(which ffmpeg) .
        chmod +x ffmpeg

    - name: Install FFmpeg (macOS)
      if: runner.os == 'macOS'
      run: |
        # FFmpeg is usually pre-installed on GitHub runners, let's just find and copy it
        FFMPEG_PATH=$(which ffmpeg)
        if [ -z "$FFMPEG_PATH" ]; then
          brew install ffmpeg
          FFMPEG_PATH=$(which ffmpeg)
        fi
        cp "$FFMPEG_PATH" .
        chmod +x ffmpeg

    - name: Install FFmpeg (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        choco install ffmpeg --no-progress
        $ffmpegPath = Get-Command ffmpeg | Select-Object -ExpandProperty Source
        Copy-Item -Path $ffmpegPath -Destination .
        if (!(Test-Path ffmpeg.exe)) { throw "ffmpeg.exe copy failed" }

    - name: Build with PyInstaller (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        pyinstaller --onefile --windowed --name=${{ matrix.artifact_name }} \
          --add-binary "ffmpeg:." \
          --hidden-import=youtube_segment_downloader \
          --hidden-import=youtube_segment_downloader.downloader \
          --hidden-import=youtube_segment_downloader.cli \
          youtube_segment_downloader_gui.py

    - name: Build with PyInstaller (Windows)
      if: runner.os == 'Windows'
      run: |
        pyinstaller --onefile --windowed --name=yt-segment-gui `
          --add-binary "ffmpeg.exe;." `
          --hidden-import=youtube_segment_downloader `
          --hidden-import=youtube_segment_downloader.downloader `
          --hidden-import=youtube_segment_downloader.cli `
          youtube_segment_downloader_gui.py

    - name: Upload to Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v2
      with:
        files: dist/${{ matrix.artifact_name }}
        tag_name: ${{ github.event.release.tag_name }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
